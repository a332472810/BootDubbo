<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xescm.ofc.mapper.OfcDistributionBasicInfoMapper" >
  <resultMap id="BaseResultMap" type="com.xescm.ofc.domain.OfcDistributionBasicInfo" >
    <!--
      WARNING - @mbg.generated
    -->
    <result column="trans_code" property="transCode" jdbcType="VARCHAR" />
    <result column="urgent" property="urgent" jdbcType="INTEGER" />
    <result column="departure_place" property="departurePlace" jdbcType="VARCHAR" />
    <result column="departure_province" jdbcType="VARCHAR" property="departureProvince" />
    <result column="departure_city" jdbcType="VARCHAR" property="departureCity" />
    <result column="departure_district" jdbcType="VARCHAR" property="departureDistrict" />
    <result column="departure_towns" jdbcType="VARCHAR" property="departureTowns" />
    <result column="departure_place_code" property="departurePlaceCode" jdbcType="VARCHAR" />
    <result column="destination" property="destination" jdbcType="VARCHAR" />
    <result column="destination_province" jdbcType="VARCHAR" property="destinationProvince" />
    <result column="destination_city" jdbcType="VARCHAR" property="destinationCity" />
    <result column="destination_district" jdbcType="VARCHAR" property="destinationDistrict" />
    <result column="destination_towns" jdbcType="VARCHAR" property="destinationTowns" />
    <result column="destination_code" property="destinationCode" jdbcType="VARCHAR" />
    <result column="quantity" property="quantity" jdbcType="DECIMAL" />
    <result column="weight" property="weight" jdbcType="DECIMAL" />
    <result column="cubage" property="cubage" jdbcType="VARCHAR" />
    <result column="total_standard_box" property="totalStandardBox" jdbcType="INTEGER" />
    <result column="trans_require" property="transRequire" jdbcType="VARCHAR" />
    <result column="pickup_time" property="pickupTime" jdbcType="TIMESTAMP" />
    <result column="expected_arrived_time" property="expectedArrivedTime" jdbcType="TIMESTAMP" />
    <result column="consignor_code" property="consignorCode" jdbcType="VARCHAR" />
    <result column="consignor_name" property="consignorName" jdbcType="VARCHAR" />
    <result column="consignee_code" property="consigneeCode" jdbcType="VARCHAR" />
    <result column="consignee_name" property="consigneeName" jdbcType="VARCHAR" />
    <result column="consignor_contact_code" property="consignorContactCode" jdbcType="VARCHAR" />
    <result column="consignor_contact_name" property="consignorContactName" jdbcType="VARCHAR" />
    <result column="consignee_contact_code" property="consigneeContactCode" jdbcType="VARCHAR" />
    <result column="consignee_contact_name" property="consigneeContactName" jdbcType="VARCHAR" />
    <result column="consignor_type" property="consignorType" jdbcType="VARCHAR" />
    <result column="consignee_type" property="consigneeType" jdbcType="VARCHAR" />
    <result column="carrier_code" property="carrierCode" jdbcType="VARCHAR" />
    <result column="carrier_name" property="carrierName" jdbcType="VARCHAR" />
    <result column="order_code" property="orderCode" jdbcType="VARCHAR" />
    <result column="plate_number" jdbcType="VARCHAR" property="plateNumber" />
    <result column="driver_name" jdbcType="VARCHAR" property="driverName" />
    <result column="contact_number" jdbcType="VARCHAR" property="contactNumber" />
    <result column="base_id" jdbcType="VARCHAR" property="baseId" />
    <result column="creation_time" property="creationTime" jdbcType="TIMESTAMP" />
    <result column="creator" property="creator" jdbcType="VARCHAR" />
    <result column="operator" property="operator" jdbcType="VARCHAR" />
    <result column="oper_time" property="operTime" jdbcType="TIMESTAMP" />
    <result column="consignor_contact_phone" property="consignorContactPhone" jdbcType="VARCHAR" />
    <result column="consignee_contact_phone" property="consigneeContactPhone" jdbcType="VARCHAR" />
    <result column="goods_type" jdbcType="VARCHAR" property="goodsType" />
    <result column="goods_type_name" jdbcType="VARCHAR" property="goodsTypeName" />
  </resultMap>
  <delete id="deleteByOrderCode" parameterType="java.lang.String" >
    <!--
      根据订单编号进行删除
    -->
    delete from ofc_distribution_basic_info
    where order_code = #{orderCode,jdbcType=VARCHAR}
  </delete>
  <update id="updateByOrderCode" parameterType="com.xescm.ofc.domain.OfcDistributionBasicInfo" >
    <!--
      根据订单号进行修改
    -->
    update ofc_distribution_basic_info
    <set >
      <if test="transCode != null" >
        trans_code = #{transCode,jdbcType=VARCHAR},
      </if>
      <if test="urgent != null" >
        urgent = #{urgent,jdbcType=INTEGER},
      </if>
      <if test="departurePlace != null" >
        departure_place = #{departurePlace,jdbcType=INTEGER},
      </if>
      <if test="departureProvince != null" >
        departure_province = #{departureProvince,jdbcType=INTEGER},
      </if>
      <if test="departureCity != null" >
        departure_city = #{departureCity,jdbcType=INTEGER},
      </if>
      <if test="departureDistrict != null" >
        departure_district = #{departureDistrict,jdbcType=INTEGER},
      </if>
      <if test="departureTowns != null" >
        departure_towns = #{departureTowns,jdbcType=INTEGER},
      </if>
      <if test="departurePlaceCode != null" >
        departure_place_code = #{departurePlaceCode,jdbcType=INTEGER},
      </if>
      <if test="destination != null" >
        destination = #{destination,jdbcType=INTEGER},
      </if>
      <if test="destinationProvince != null" >
        destination_province = #{destinationProvince,jdbcType=INTEGER},
      </if>
      <if test="destinationCity != null" >
        destination_city = #{destinationCity,jdbcType=INTEGER},
      </if>
      <if test="destinationDistrict != null" >
        destination_district = #{destinationDistrict,jdbcType=INTEGER},
      </if>
      <if test="destinationTowns != null" >
        destination_towns = #{destinationTowns,jdbcType=INTEGER},
      </if>
      <if test="destinationCode != null" >
        destination_code = #{destinationCode,jdbcType=INTEGER},
      </if>
      <if test="quantity != null" >
        quantity = #{quantity,jdbcType=INTEGER},
      </if>
      <if test="weight != null" >
        weight = #{weight,jdbcType=INTEGER},
      </if>
      <if test="cubage != null" >
        cubage = #{cubage,jdbcType=INTEGER},
      </if>
      <if test="totalStandardBox != null" >
        total_standard_box = #{totalStandardBox,jdbcType=INTEGER},
      </if>
      <if test="transRequire != null" >
        trans_require = #{transRequire,jdbcType=INTEGER},
      </if>
      <if test="pickupTime != null" >
        pickup_time = #{pickupTime,jdbcType=INTEGER},
      </if>
      <if test="expectedArrivedTime != null" >
        expected_arrived_time = #{expectedArrivedTime,jdbcType=INTEGER},
      </if>
      <if test="consignorCode != null" >
        consignor_code = #{consignorCode,jdbcType=INTEGER},
      </if>
      <if test="consignorName != null" >
        consignor_name = #{consignorName,jdbcType=INTEGER},
      </if>
      <if test="consigneeCode != null" >
        consignee_code = #{consigneeCode,jdbcType=INTEGER},
      </if>
      <if test="consigneeName != null" >
        consignee_name = #{consigneeName,jdbcType=INTEGER},
      </if>
      <if test="consignorContactCode != null" >
        consignor_contact_code = #{consignorContactCode,jdbcType=INTEGER},
      </if>
      <if test="consignorContactName != null" >
        consignor_contact_name = #{consignorContactName,jdbcType=INTEGER},
      </if>
      <if test="consigneeContactCode != null" >
        consignee_contact_code = #{consigneeContactCode,jdbcType=INTEGER},
      </if>

      <if test="consignorContactPhone != null" >
        consignor_contact_phone = #{consignorContactPhone,jdbcType=INTEGER},
      </if>
      <if test="consigneeContactPhone != null" >
        consignee_contact_phone = #{consigneeContactPhone,jdbcType=INTEGER},
      </if>



      <if test="consigneeContactName != null" >
        consignee_contact_name = #{consigneeContactName,jdbcType=INTEGER},
      </if>
      <if test="consignorType != null" >
        consignor_type = #{consignorType,jdbcType=INTEGER},
      </if>
      <if test="consigneeType != null" >
        consignee_type = #{consigneeType,jdbcType=INTEGER},
      </if>
      <if test="carrierCode != null" >
        carrier_code = #{carrierCode,jdbcType=INTEGER},
      </if>
      <if test="carrierName != null" >
        carrier_name = #{carrierName,jdbcType=INTEGER},
      </if>
      <if test="orderCode != null" >
        order_code = #{orderCode,jdbcType=INTEGER},
      </if>
      <if test="plateNumber != null" >
        plate_number = #{plateNumber,jdbcType=INTEGER},
      </if>
      <if test="driverName != null" >
        driver_name = #{driverName,jdbcType=INTEGER},
      </if>
      <if test="contactNumber != null" >
        contact_number = #{contactNumber,jdbcType=INTEGER},
      </if>
      <if test="baseId != null" >
        base_id = #{baseId,jdbcType=INTEGER},
      </if>
      <if test="creationTime != null" >
        creation_time = #{creationTime,jdbcType=INTEGER},
      </if>
      <if test="creator != null" >
        creator = #{creator,jdbcType=INTEGER},
      </if>
      <if test="operator != null" >
        operator = #{operator,jdbcType=INTEGER},
      </if>
      <if test="operTime != null" >
        oper_time = #{operTime,jdbcType=INTEGER}
      </if>
    </set>
    where order_code = #{orderCode,jdbcType=VARCHAR}
  </update>

  <select id="queryByOrderCode" parameterType="java.lang.String" resultMap="BaseResultMap">
    SELECT
    ofd.transCode,
    ofd.urgent,
    ofd.departurePlace,
    ofd.departureProvince,
    ofd.departureCity,
    ofd.departureDistrict,
    ofd.departureTowns,
    ofd.departurePlaceCode,
    ofd.destination,
    ofd.destinationProvince,
    ofd.destinationCity,
    ofd.destinationDistrict,
    ofd.destinationTowns,
    ofd.destinationCode,
    ofd.quantity,
    ofd.weight,
    ofd.cubage,
    ofd.totalStandardBox,
    ofd.transRequire,
    ofd.pickupTime,
    ofd.expectedArrivedTime,
    ofd.consignorCode,
    ofd.consignorName,
    ofd.consigneeCode,
    ofd.consigneeName,
    ofd.consignorContactCode,
    ofd.consignorContactName,
    ofd.consigneeContactCode,
    ofd.consigneeContactName,
    ofd.consignorType,
    ofd.consigneeType,
    ofd.carrierCode,
    ofd.carrierName,
    ofd.orderCode,
    ofd.plateNumber,
    ofd.driverName,
    ofd.baseId,
    ofd.contactNumber,
    ofd.creationTime,
    ofd.creator,
    ofd.operator,
    ofd.operTime,
    ofd.consignorContactPhone,
    ofd.consigneeContactPhone,
    ofd.goodsType,
    ofd.goodsTypeName,
    ofd.selfTransCode
    FROM ofc_distribution_basic_info ofd
    WHERE ofd.order_code = #{orderCode,jdbcType=VARCHAR}
    ORDER BY ofd.oper_time DESC limit 1
  </select>

  <!--
      根据订单号进行查询对应数据
    -->
  <select id="ofcDistributionBasicInfoSelect" parameterType="java.lang.String" resultMap="BaseResultMap">
    SELECT
    ofd.transCode,
    ofd.urgent,
    ofd.departurePlace,
    ofd.departureProvince,
    ofd.departureCity,
    ofd.departureDistrict,
    ofd.departureTowns,
    ofd.departurePlaceCode,
    ofd.destination,
    ofd.destinationProvince,
    ofd.destinationCity,
    ofd.destinationDistrict,
    ofd.destinationTowns,
    ofd.destinationCode,
    ofd.quantity,
    ofd.weight,
    ofd.cubage,
    ofd.totalStandardBox,
    ofd.transRequire,
    ofd.pickupTime,
    ofd.expectedArrivedTime,
    ofd.consignorCode,
    ofd.consignorName,
    ofd.consigneeCode,
    ofd.consigneeName,
    ofd.consignorContactCode,
    ofd.consignorContactName,
    ofd.consigneeContactCode,
    ofd.consigneeContactName,
    ofd.consignorType,
    ofd.consigneeType,
    ofd.carrierCode,
    ofd.carrierName,
    ofd.orderCode,
    ofd.plateNumber,
    ofd.driverName,
    ofd.baseId,
    ofd.contactNumber,
    ofd.creationTime,
    ofd.creator,
    ofd.operator,
    ofd.operTime,
    ofd.consignorContactPhone,
    ofd.consigneeContactPhone,
    ofd.goodsType,
    ofd.goodsTypeName,
    ofd.selfTransCode
    FROM ofc_distribution_basic_info ofd
        WHERE ofd.order_code =#{orderCode,jdbcType=VARCHAR}
    ORDER BY ofd.oper_time DESC limit 1
  </select>

  <!--
    根据运输单号查订单号
  -->
  <resultMap id="convTransCode" type="java.lang.String" >
     <result column="order_code" property="orderCode" jdbcType="VARCHAR" />
  </resultMap>

  <select id="getOrderCodeByTransCode" parameterType="java.util.Map" resultMap="convTransCode">
    SELECT
    odbi.order_code
    FROM
    ofc_fundamental_information ofi
    LEFT JOIN ofc_distribution_basic_info odbi ON ofi.order_code = odbi.order_code
    <where>
      <if test="custCode　!= null and custCode != ''">
        AND ofi.cust_code = #{custCode,jdbcType=VARCHAR}
      </if>
      <if test="transCode　!= null and transCode != ''">
        AND odbi.trans_code =#{transCode,jdbcType=VARCHAR}
      </if>
    </where>
        ORDER BY odbi.oper_time DESC limit 1
  </select>


  <select id="getKabanOrderCodeByTransCode" parameterType="java.util.Map" resultMap="convTransCode">
    SELECT
    odbi.order_code
    FROM
    ofc_fundamental_information ofi
    LEFT JOIN ofc_distribution_basic_info odbi ON ofi.order_code = odbi.order_code
    <where>
      <if test="custCode!=null and custCode!=''">
        AND ofi.cust_code = #{custCode,jdbcType=VARCHAR}
      </if>
      <if test="transCode!=null and transCode!=''">
        AND odbi.trans_code =#{transCode,jdbcType=VARCHAR}
      </if>
      AND ofi.business_type = '602'
    </where>
    ORDER BY odbi.oper_time DESC limit 1
  </select>


  <select id="checkTransCode" parameterType="com.xescm.ofc.domain.OfcDistributionBasicInfo" resultType="java.lang.Integer">
    SELECT
    count(odbi.order_code) AS countOrderCode
    FROM
    (
    SELECT
    s.order_code,
    s.order_status,
    s.status_desc,
    s.lasted_oper_time,
    s.notes,
    s.operator,
    s.creation_time
    FROM
    ofc_order_status s,
    (
    SELECT
    s.order_code,
    max(s.lasted_oper_time) val
    FROM
    ofc_order_status s
    GROUP BY
    s.order_code
    ) b
    WHERE
    s.order_code = b.order_code
    AND s.lasted_oper_time = b.val
    ORDER BY
    s.order_code
    ) oos
    LEFT JOIN ofc_distribution_basic_info odbi ON oos.order_code = odbi.order_code
    <where>
      <if test="selfTransCode != null and selfTransCode != ''" >
        trans_code != #{selfTransCode}
      </if>
      AND
      trans_code = #{transCode}
      AND oos.order_status!='50'
    </where>
  </select>


  <resultMap id="OfcBatchOrderMap" type="com.xescm.ofc.model.vo.ofc.OfcBatchOrderVo" >
    <result column="orderCode" property="order_code" jdbcType="VARCHAR" />
    <result column="batch_order_number" property="batchOrderNumber" jdbcType="VARCHAR" />
    <result column="cust_name" property="custName" jdbcType="VARCHAR" />
    <result column="order_time" property="orderTime" jdbcType="TIMESTAMP" />
    <result column="warehouse_name" property="warehouseName" jdbcType="DECIMAL" />
    <result column="notes" property="notes" jdbcType="VARCHAR" />
    <result column="consignor_name" property="consignorName" jdbcType="VARCHAR" />
    <result column="consignor_contact_name" property="consignorContactName" jdbcType="VARCHAR" />
    <result column="consignor_contact_phone" property="consignorContactPhone" jdbcType="VARCHAR" />
    <result column="departure" property="departure" jdbcType="VARCHAR" />
  </resultMap>
  <select id="queryByBatchNumber" resultType="com.xescm.ofc.model.vo.ofc.OfcBatchOrderVo">
    SELECT
    ofi.order_code,
    ofi.order_batch_number,
    ofi.cust_name,
    ofi.order_time,
    owi.warehouse_name,
    ofi.notes,
    dbi.consignor_name,
    dbi.consignor_contact_name,
    dbi.consignor_contact_phone,
    CONCAT(
    IFNULL(dbi.departure_province, ""),
    IFNULL(dbi.departure_city, ""),
    IFNULL(dbi.departure_district, ""),
    IFNULL(dbi.departure_towns, ""),
    IFNULL(dbi.departure_place, "")
    ) AS departure
    FROM
    ofc_fundamental_information ofi,
    ofc_distribution_basic_info dbi,
    ofc_warehouse_information owi
    WHERE
    ofi.order_code = dbi.order_code
    AND ofi.order_code = owi.order_code
    AND ofi.order_batch_number = #{orderBatchNumber}
    LIMIT 1
  </select>


</mapper>