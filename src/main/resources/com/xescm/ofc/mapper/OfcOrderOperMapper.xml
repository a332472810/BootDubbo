<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xescm.ofc.mapper.OfcOrderOperMapper" >
  <resultMap id="BaseResultMap" type="com.xescm.ofc.domain.OfcOrderOper" >
    <id column="order_code" property="orderCode" jdbcType="VARCHAR" />
    <result column="order_batch_number" property="orderBatchNumber" jdbcType="VARCHAR" />
    <result column="order_time" property="orderTime" jdbcType="TIMESTAMP" />
    <result column="cust_code" property="custCode" jdbcType="VARCHAR" />
    <result column="cust_name" property="custName" jdbcType="VARCHAR" />
    <result column="sec_cust_code" property="secCustCode" jdbcType="VARCHAR" />
    <result column="sec_cust_name" property="secCustName" jdbcType="VARCHAR" />
    <result column="order_type" property="orderType" jdbcType="VARCHAR" />
    <result column="business_type" property="businessType" jdbcType="VARCHAR" />
    <result column="cust_order_code" property="custOrderCode" jdbcType="VARCHAR" />
    <result column="notes" property="notes" jdbcType="VARCHAR" />
    <result column="store_code" property="storeCode" jdbcType="VARCHAR" />
    <result column="store_name" property="storeName" jdbcType="VARCHAR" />
    <result column="platform_type" property="platformType" jdbcType="VARCHAR" />
    <result column="order_source" property="orderSource" jdbcType="VARCHAR" />
    <result column="product_type" property="productType" jdbcType="VARCHAR" />
    <result column="product_name" property="productName" jdbcType="VARCHAR" />
    <result column="finished_time" property="finishedTime" jdbcType="TIMESTAMP" />
    <result column="abolish_mark" property="abolishMark" jdbcType="INTEGER" />
    <result column="abolish_time" property="abolishTime" jdbcType="TIMESTAMP" />
    <result column="abolisher" property="abolisher" jdbcType="VARCHAR" />
    <result column="creation_time" property="creationTime" jdbcType="TIMESTAMP" />
    <result column="creator" property="creator" jdbcType="VARCHAR" />
    <result column="operator" property="operator" jdbcType="VARCHAR" />
    <result column="oper_time" property="operTime" jdbcType="TIMESTAMP" />
    <result column="sale_organization" property="saleOrganization" jdbcType="VARCHAR" />
    <result column="product_group" property="productGroup" jdbcType="VARCHAR" />
    <result column="sale_department" property="saleDepartment" jdbcType="VARCHAR" />
    <result column="sale_group" property="saleGroup" jdbcType="VARCHAR" />
    <result column="sale_department_desc" property="saleDepartmentDesc" jdbcType="VARCHAR" />
    <result column="sale_group_desc" property="saleGroupDesc" jdbcType="VARCHAR" />
    <result column="creator_name" property="creatorName" jdbcType="VARCHAR" />
    <result column="operator_name" property="operatorName" jdbcType="VARCHAR" />
    <result column="abolisher_name" property="abolisherName" jdbcType="VARCHAR" />
    <result column="merchandiser" property="merchandiser" jdbcType="VARCHAR" />
    <result column="transport_type" property="transportType" jdbcType="VARCHAR" />

    <!-- ofc_distribution_basic_info -->
    <result column="trans_code" property="transCode" jdbcType="VARCHAR" />
    <result column="urgent" property="urgent" jdbcType="INTEGER" />
    <result column="departure_place" property="departurePlace" jdbcType="VARCHAR" />
    <result column="departure_province" property="departureProvince" jdbcType="VARCHAR" />
    <result column="departure_city" property="departureCity" jdbcType="VARCHAR" />
    <result column="departure_district" property="departureDistrict" jdbcType="VARCHAR" />
    <result column="departure_towns" property="departureTowns" jdbcType="VARCHAR" />
    <result column="departure_place_code" property="departurePlaceCode" jdbcType="VARCHAR" />
    <result column="destination" property="destination" jdbcType="VARCHAR" />
    <result column="destination_province" property="destinationProvince" jdbcType="VARCHAR" />
    <result column="destination_city" property="destinationCity" jdbcType="VARCHAR" />
    <result column="destination_district" property="destinationDistrict" jdbcType="VARCHAR" />
    <result column="destination_towns" property="destinationTowns" jdbcType="VARCHAR" />
    <result column="destination_code" property="destinationCode" jdbcType="VARCHAR" />
    <result column="quantity" property="quantity" jdbcType="DECIMAL" />
    <result column="weight" property="weight" jdbcType="DECIMAL" />
    <result column="cubage" property="cubage" jdbcType="VARCHAR" />
    <result column="total_standard_box" property="totalStandardBox" jdbcType="INTEGER" />
    <result column="trans_require" property="transRequire" jdbcType="VARCHAR" />
    <result column="pickup_time" property="pickupTime" jdbcType="TIMESTAMP" />
    <result column="expected_arrived_time" property="expectedArrivedTime" jdbcType="TIMESTAMP" />
    <result column="consignor_code" property="consignorCode" jdbcType="VARCHAR" />
    <result column="consignor_name" property="consignorName" jdbcType="VARCHAR" />
    <result column="consignee_code" property="consigneeCode" jdbcType="VARCHAR" />
    <result column="consignee_name" property="consigneeName" jdbcType="VARCHAR" />
    <result column="carrier_code" property="carrierCode" jdbcType="VARCHAR" />
    <result column="carrier_name" property="carrierName" jdbcType="VARCHAR" />
    <result column="order_code" property="orderCode" jdbcType="VARCHAR" />
    <result column="plate_number" property="plateNumber" jdbcType="VARCHAR" />
    <result column="driver_name" property="driverName" jdbcType="VARCHAR" />
    <result column="contact_number" property="contactNumber" jdbcType="VARCHAR" />
    <result column="consignor_contact_name" property="consignorContactName" jdbcType="VARCHAR" />
    <result column="consignor_contact_code" property="consignorContactCode" jdbcType="VARCHAR" />
    <result column="consignee_contact_name" property="consigneeContactName" jdbcType="VARCHAR" />
    <result column="consignee_contact_code" property="consigneeContactCode" jdbcType="VARCHAR" />
    <result column="consignor_type" property="consignorType" jdbcType="VARCHAR" />
    <result column="consignee_type" property="consigneeType" jdbcType="VARCHAR" />
    <result column="base_id" property="baseId" jdbcType="VARCHAR" />
    <result column="consignor_contact_phone" property="consignorContactPhone" jdbcType="VARCHAR" />
    <result column="consignee_contact_phone" property="consigneeContactPhone" jdbcType="VARCHAR" />

    <!--ofc_finance_information-->
    <result column="service_charge" property="serviceCharge" jdbcType="DECIMAL" />
    <result column="order_amount" property="orderAmount" jdbcType="DECIMAL" />
    <result column="payment_amount" property="paymentAmount" jdbcType="DECIMAL" />
    <result column="collect_loan_amount" property="collectLoanAmount" jdbcType="DECIMAL" />
    <result column="collect_service_charge" property="collectServiceCharge" jdbcType="DECIMAL" />
    <result column="collect_flag" property="collectFlag" jdbcType="VARCHAR" />
    <result column="count_flag" property="countFlag" jdbcType="VARCHAR" />
    <result column="order_code" property="orderCode" jdbcType="VARCHAR" />
    <result column="print_invoice" property="printInvoice" jdbcType="VARCHAR" />
    <result column="buyer_payment_method" property="buyerPaymentMethod" jdbcType="VARCHAR" />
    <result column="insure" property="insure" jdbcType="VARCHAR" />
    <result column="insure_value" property="insureValue" jdbcType="VARCHAR" />
    <result column="pick_up_goods" property="pickUpGoods" jdbcType="VARCHAR" />
    <result column="home_delivery_fee" property="homeDeliveryFee" jdbcType="DECIMAL" />
    <result column="cargo_insurance_fee" property="cargoInsuranceFee" jdbcType="DECIMAL" />
    <result column="insurance" property="insurance" jdbcType="DECIMAL" />
    <result column="two_distribution" property="twoDistribution" jdbcType="VARCHAR" />
    <result column="two_distribution_fee" property="twoDistributionFee" jdbcType="DECIMAL" />
    <result column="return_list" property="returnList" jdbcType="VARCHAR" />
    <result column="return_list_fee" property="returnListFee" jdbcType="DECIMAL" />
    <result column="expense_payment_party" property="expensePaymentParty" jdbcType="VARCHAR" />
    <result column="payment" property="payment" jdbcType="VARCHAR" />
    <result column="current_amount" property="currentAmount" jdbcType="DECIMAL" />
    <result column="to_pay_amount" property="toPayAmount" jdbcType="DECIMAL" />
    <result column="return_amount" property="returnAmount" jdbcType="DECIMAL" />
    <result column="monthly_amount" property="monthlyAmount" jdbcType="DECIMAL" />
    <result column="luggage" property="luggage" jdbcType="DECIMAL" />

  <!--ofc_order_status-->
    <result column="order_status" property="orderStatus" jdbcType="VARCHAR"></result>
    <result column="status_desc" property="statusDesc" jdbcType="VARCHAR"></result>
    <result column="lasted_oper_time" property="lastedOperTime" jdbcType="TIMESTAMP"></result>

  </resultMap>
  <sql id="Base_Column_List_Fundamental" >
    order_code, order_batch_number, order_time, cust_code, cust_name, sec_cust_code, 
    sec_cust_name, order_type, business_type, cust_order_code, notes, store_code, store_name, 
    platform_type, order_source, product_type, product_name, finished_time, abolish_mark, 
    abolish_time, abolisher, creation_time, creator, operator, oper_time, sale_organization, 
    product_group, sale_department, sale_group, sale_department_desc, sale_group_desc, 
    creator_name, operator_name, abolisher_name, merchandiser, transport_type
  </sql>
  
  <resultMap id="Order_Search_Oper_Map" type="com.xescm.ofc.domain.OrderSearchOperResult">
    <result column="cust_name" property="custName" jdbcType="VARCHAR"></result>
    <result column="order_code" property="orderCode" jdbcType="VARCHAR"></result>
    <result column="cust_order_code" property="custOrderCode" jdbcType="VARCHAR"></result>
    <result column="order_batch_number" property="orderBatchNumber" jdbcType="VARCHAR"></result>
    <result column="order_time" property="orderTime" jdbcType="TIMESTAMP"></result>
    <result column="order_type" property="orderType" jdbcType="VARCHAR"></result>
    <result column="business_type" property="businessType" jdbcType="TIMESTAMP"></result>
    <result column="order_status" property="orderStatus" jdbcType="VARCHAR"></result>
    <result column="consignee_type" property="consigneeType" jdbcType="VARCHAR"></result>
    <result column="consignee_name" property="consigneeName" jdbcType="VARCHAR"></result>
    <result column="consignee_contact_name" property="consigneeContactName" jdbcType="VARCHAR"></result>
    <result column="warehouse_name" property="warehouseName" jdbcType="VARCHAR"></result>
    <result column="notes" property="notes" jdbcType="VARCHAR"></result>
    <result column="store_name" property="storeName" jdbcType="VARCHAR"></result>
  </resultMap>

  <!-- 运营-订单管理查询 -->
  <select id="queryOrderList" resultMap="Order_Search_Oper_Map">
    SELECT DISTINCT
      ofi.cust_name,
      ofi.order_code,
      ofi.cust_order_code,
      ofi.order_batch_number,
      ofi.order_time,
      ofi.order_type,
      ofi.business_type,
      oos.order_status,
      odbi.consignee_type,
      odbi.consignee_name,
      odbi.consignee_contact_name,
      owi.warehouse_name,
      ofi.notes,
      ofi.store_name
    FROM
    ofc_fundamental_information ofi
      LEFT JOIN (
      SELECT temp.* FROM ofc_order_status temp
      WHERE temp.lasted_oper_time = (
      SELECT MAX(lasted_oper_time) FROM ofc_order_status
      WHERE temp.order_code = order_code
      AND notes NOT LIKE '%已回单'
      ) ORDER BY temp.lasted_oper_time DESC
      ) oos ON ofi.order_code = oos.order_code
      LEFT JOIN ofc_distribution_basic_info odbi ON ofi.order_code = odbi.order_code
      LEFT JOIN ofc_warehouse_information owi ON ofi.order_code = owi.order_code
    <where>
      <if test="form.startDate!=null and form.startDate!=''">
        AND ofi.order_time <![CDATA[ >= ]]>  #{form.startDate}
      </if>
      <if test="form.endDate!=null and form.endDate!=''">
        AND ofi.order_time <![CDATA[ <= ]]>  #{form.endDate}
      </if>
      <if test="form.orderCode!=null and form.orderCode!=''">
        AND ofi.order_code = #{form.orderCode}
      </if>
      <if test="form.custName!=null and form.custName!=''">
        AND ofi.cust_name = #{form.custName}
      </if>
      <if test="form.orderState!=null and form.orderState!=''">
        AND oos.order_status = #{form.orderState}
      </if>
      <if test="form.orderType!=null and form.orderType!=''">
        AND ofi.order_type = #{form.orderType}
      </if>
      <if test="form.businessType!=null and form.businessType!=''">
        AND ofi.business_type = #{form.businessType}
      </if>
    </where>
    ORDER BY ofi.order_code DESC
  </select>

  <select id="queryOrderByOrderBatchNumber" resultMap="Order_Search_Oper_Map">
    SELECT
      ofi.order_code,
      ofi.cust_order_code,
      ofi.order_time,
      ofi.order_type,
      ofi.business_type,
      odb.consignee_name,
      oos.order_status,
      owi.warehouse_name,
      ofi.notes
    FROM
      ofc_fundamental_information ofi
    LEFT JOIN (
      SELECT
        temp.*
        FROM
          ofc_order_status temp
        WHERE temp.lasted_oper_time =
        (SELECT MAX(lasted_oper_time) FROM ofc_order_status
          WHERE temp.order_code = order_code
        ) ORDER BY temp.lasted_oper_time DESC) oos
     ON ofi.order_code = oos.order_code
    LEFT JOIN ofc_distribution_basic_info odb
    ON odb.order_code = ofi.order_code
    LEFT JOIN ofc_warehouse_information owi
    ON ofi.order_code = owi.order_code
    WHERE ofi.order_batch_number = #{orderBatchNumber}
  </select>

  <resultMap id="Order_Follow_Oper_Map" type="com.xescm.ofc.domain.OrderFollowOperResult">
    <result column="order_code" property="orderCode" jdbcType="VARCHAR"/>
    <result column="cust_order_code" property="custOrderCode" jdbcType="VARCHAR"/>
    <result column="order_batch_number" property="orderBatchNumber" jdbcType="VARCHAR"/>
    <result column="order_time" property="orderTime" jdbcType="TIMESTAMP"/>
    <result column="cust_name" property="custName" jdbcType="VARCHAR"/>
    <result column="order_status" property="orderStatus" jdbcType="VARCHAR"/>
    <result column="order_type" property="orderType" jdbcType="VARCHAR"/>
    <result column="business_type" property="businessType" jdbcType="VARCHAR"/>
    <result column="transport_type" property="transportType" jdbcType="VARCHAR"/>
    <result column="departure_place" property="departurePlace" jdbcType="VARCHAR"/>
    <result column="destination" property="destination" jdbcType="VARCHAR"/>
    <result column="trans_code" property="transCode" jdbcType="VARCHAR"/>
    <result column="plate_number" property="plateNumber" jdbcType="VARCHAR"/>
    <result column="driver_name" property="driverName" jdbcType="VARCHAR"/>
    <result column="contact_number" property="contactNumber" jdbcType="VARCHAR"/>
    <result column="destination_province" property="destinationProvince" jdbcType="VARCHAR"/>
    <result column="destination_city" property="destinationCity" jdbcType="VARCHAR"/>
    <result column="destination_district" property="destinationDistrict" jdbcType="VARCHAR"/>
    <result column="destination_towns" property="destinationTowns" jdbcType="VARCHAR"/>
    <result column="departure_province" property="departureProvince" jdbcType="VARCHAR"/>
    <result column="departure_city" property="departureCity" jdbcType="VARCHAR"/>
    <result column="departure_district" property="departureDistrict" jdbcType="VARCHAR"/>
    <result column="departure_towns" property="departureTowns" jdbcType="VARCHAR"/>
  </resultMap>
  
  <!--订单追踪-->
  <select id="queryOrder" resultMap="Order_Follow_Oper_Map">
    SELECT
    ofi.order_code,
    ofi.cust_order_code,
    ofi.order_batch_number,
    ofi.order_time,
    ofi.cust_name,
    oos.order_status,
    ofi.order_type,
    ofi.business_type,
    ofi.transport_type,
    ofd.departure_place,
    ofd.destination,
    ofd.trans_code,
    ofd.plate_number,
    ofd.driver_name,
    ofd.contact_number,
    ofd.destination_province,
    ofd.destination_city,
    ofd.destination_district,
    ofd.destination_towns,
    ofd.departure_province,
    ofd.departure_city,
    ofd.departure_district,
    ofd.departure_towns
    FROM
    ofc_fundamental_information ofi
    LEFT JOIN ofc_distribution_basic_info ofd
    ON ofi.order_code = ofd.order_code
    LEFT JOIN (SELECT temp.* FROM ofc_order_status temp
    WHERE temp.lasted_oper_time = (
    SELECT MAX(lasted_oper_time) FROM ofc_order_status
    WHERE temp.order_code = order_code
    ) ORDER BY temp.lasted_oper_time DESC) oos
    ON ofi.order_code = oos.order_code
    WHERE 1= 1
    <choose>
      <when test=" 'orderCode'.toString() == searchType ">
        AND ofi.order_code = #{code}
      </when>
      <when test="'custOrderCode'.toString() == searchType">
        AND ofi.cust_order_code = #{code}
      </when>
      <when test="'transCode'.toString() == searchType">
        AND ofd.trans_code = #{code}
      </when>
      <when test=" 'planCode'.toString() == searchType">
        and ofi.order_code = (SELECT order_code from ofc_transplan_info where plan_code = #{code})
      </when>
      <otherwise></otherwise>
    </choose>

  </select>




</mapper>